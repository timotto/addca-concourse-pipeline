jobs:
- name: bootstrap-pipeline
  public: true
  plan:
  - aggregate:
    - get: ca-src
      trigger: true
  - aggregate:
    - task: bootstrap-pipeline
      file: ca-src/src/main/ci/bootstrap-pipeline.yaml
    - task: build-secrets
      file: ca-src/src/main/ci/build-secrets.yaml
      params:
        git_private_key: {{git-private-key}}
        docker_images_git: {{docker-images-git}}
        docker_images_git_branch: {{docker-images-git-branch}}
        certificates_git: {{certificates-git}}
        certificates_git_branch: {{certificates-git-branch}}
        addca_git: {{addca-git}}
        addca_git_branch: {{addca-git-branch}}
        docker_registry_username: {{docker-registry-username}}
        docker_registry_password: {{docker-registry-password}}
        docker_registry_prefix: {{docker-registry-prefix}}
        concourse_pipeline: {{concourse-pipeline}}
        concourse_target: {{concourse-target}}
        concourse_insecure: {{concourse-insecure}}
        concourse_team: {{concourse-team}}
        concourse_username: {{concourse-username}}
        concourse_password: {{concourse-password}}
  - put: addca-pipeline
    params:
      pipelines:
      - name: {{concourse-pipeline}}
        team: {{concourse-team}}
        config_file: bootstrap-output/pipeline.yaml
        vars_files:
        - secrets-output/secrets.yaml

resources:
- name: ca-src
  type: git
  source:
    uri: {{addca-git}}
    branch: {{addca-git-branch}}

- name: addca-pipeline
  type: concourse-pipeline
  source:
    target: {{concourse-target}}
    insecure: {{concourse-insecure}}
    teams:
    - name: {{concourse-team}}
      username: {{concourse-username}}
      password: {{concourse-password}}

resource_types:
- name: concourse-pipeline
  type: docker-image
  source:
    repository: robdimsdale/concourse-pipeline-resource
    tag: latest-final
